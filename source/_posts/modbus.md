---
title: modbus
author: wflin
date: 2020-6-1
tags:
  - iot
  - modbus
top: false
cover: false
toc: false
mathjax: true
summary: "modbus"
categories:
  - iot
---



## GitHub中拉取源码



> git clone https://github.com/stephane/libmodbus.git

* 如果无法访问 GitHub 网站，自行百度魔法。进行访问

## 编译源码

```shell
cd libmodbus # 进入目录
./autogen.sh # 生成 congfig 文件
```

* 这里可能会报错，`autoreconf` 找不到

解决办法：

* centos 下载：

> sudo yum install -y autoconf automake libtool

* ubuntu 下载

> sudo apt-get install -y autoconf automake libtool

下载完成再次运行脚本，控制台会生成,则表示生成 config文件成功

```txt
------------------------------------------------------
Initialized build system. You can now run ./configure 
------------------------------------------------------
```

## 生成modbus的 makefile 文件

使用命令：

* 个人喜欢将其安装在 usr 目录下，因为不是系统自带，是用户自己安装方便管理

> ```shell
> ./configure --prefix=/usr/local/
> ```

## make 编译

* make 指令，-j2 为采用2个核心去编译。编译更快

> make -j2 

* 这里可能会报错 需要 gcc 为c99 标准，而gcc 编译器默认支持 c89 编译器，所有此时 makefile make时会报错

```txt
modbus.c: In function 'read_io_status':
modbus.c:1202:9: error: 'for' loop initial declarations are only allowed in C99 mode
         for (unsigned int i = offset; i < offset_end; i++) {
         ^
modbus.c:1202:9: note: use option -std=c99 or -std=gnu99 to compile your code
```



* 更改命令可完成编译

> make -j2 CFLAGS=-std=c99

## make 安装

> make install 

* 全程无报错则安装成功





## modbus 报文结构

### 下行帧

* **11 01 00 13 00 25 F9 C8**

```
  01		01 		  0013     0025		F9C8
从机地址	操作码		起始地址   数据数量	  CRC
```

* 11为从机地址（1byte），地址号17；

* 01为功能码（1bye），读线圈状态；

* 0013为寄存器起始地址（2byte），起始地址19；
  * **备注：程序的起始地址为0。起始地址19实际上是第20号接触器。**

* 0025为数据数量（2byte），37个状态量，需要5个字节的空间；

* F9C8为CRC码（2byte）。
  * **释义：读取来自17号从机以20号接触器为起始的37个接触器状态。**

### 上行帧

* **上行帧：11 01 05 CD 6B B2 0E 1B 18 8D**

* 11为从机地址（1byte），地址号17；

* 01为功能码（1byte），读线圈状态；

* 05为数据区字节数（1byte），5个字节；

* CD 6B B2 0E 1B为数据（5byte），仅解析第一个数据（CD）,CD转为二进制序列为11001101，**从低位到高位读**，每一位对应一个接触器的状态，0为分，1为合。

* 综上数据段中的CD，表示20号接触器合位、21号分位、22号合位、23号合位、24号分位、25号分位、26号合位、27号合位；

* 18 8D为CRC码（2byte）。
  * **释义：上送来自17号从机的接触器状态，其数据字节数为5，信息为20号接触器合位、21号分位、22号合位、23号合位、24号分位、25号分位、26号合位、27号合位……**

## ModBus Poll

* Tx = 0 ：发送帧数

* Err = 0：错误帧数

* ID = 1：从站ID

* F = 03 功能码

* SR = 1000ms：轮询周期

* No connection 无连接

  ![image-20230426150558525](F:/blog/source/_posts/modbus.assets/image-20230426150558525.png)

## Slave

* 从机配置

  ![image-20230426151108754](F:/blog/source/_posts/modbus.assets/image-20230426151108754.png)

* 常用功能码及其地址对应表

  ![image-20230426161902783](F:/blog/source/_posts/modbus.assets/image-20230426161902783.png)

* 修改名字及其对应的值

  ![](F:/blog/source/_posts/modbus.assets/c603849b8caf4e4ba164d1224446bf9a.png)



## 报文

### tcp报文

* 发送报文格式

  ![image-20230427173732124](F:/blog/source/_posts/modbus.assets/image-20230427173732124.png)

* 响应报文格式

![image-20230427173656515](F:/blog/source/_posts/modbus.assets/image-20230427173656515.png)

* 结构、

  * 发送报文

    ```txt
    事务处理标识 协议标识 报文长度 单元标识 功能码 起始地址 寄存器个数
     008B 		0000 	0006 	01 		03 	 0000 	000A
    ```

```
    
  * 响应的报文
  
    ```txt
    Tx:000000-00 8B 00 00 00 06 01 03 00 00 00 0A
    Rx:000001-00 8B 00 00 00 17 01 03 14 00 00 00 01 00 14 00 0A 00 00 00 00 00 00 00 00 00 00 00 00
    Tx:000002-00 8C 00 00 00 06 01 03 00 00 00 0A
    Rx:000003-00 8C 00 00 00 17 01 03 14 00 00 00 01 00 14 00 0A 00 00 00 00 00 00 00 00 00 00 00 00
    Tx:000004-00 8D 00 00 00 06 01 03 00 00 00 0A
    Rx:000005-00 8D 00 00 00 17 01 03 14 00 00 00 01 00 14 00 0A 00 00 00 00 00 00 00 00 00 00 00 00
    Tx:000006-00 8E 00 00 00 06 01 03 00 00 00 0A
    Rx:000007-00 8E 00 00 00 17 01 03 14 00 00 00 01 00 14 00 0A 00 00 00 00 00 00 00 00 00 00 00 00
```

### 串口报文

```txt
Rx:000043-01 03 14 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 A3 67
Tx:000044-01 03 00 00 00 0A C5 CD
Rx:000045-01 03 14 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 A3 67
Tx:000046-01 03 00 00 00 0A C5 CD
Rx:000047-01 03 14 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 A3 67
Tx:000048-01 06 00 00 00 0A 09 CD
Rx:000049-01 06 00 00 00 0A 09 CD
Tx:000050-01 03 00 00 00 0A C5 CD
Rx:000051-01 03 14 00 0A 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 38 BE
Tx:000052-01 03 00 00 00 0A C5 CD
Rx:000053-01 03 14 00 0A 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 38 BE
Tx:000054-01 03 00 00 00 0A C5 CD
Rx:000055-01 03 14 00 0A 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 38 BE
```

### 报文对比

```txt
00 8C 00 00 00 06 01 03 00 00 00 0A #tcp报文
01 03 00 00 00 0A C5 CD #RTU报文
```

* 

## 测试其他情况

### 通过串口测试：

#### 主站和从站寄存器连续

| 主站读取寄存器个数 | 从站读取寄存器个数 |      |                现象                |        响应报文        |
| :----------------: | :----------------: | :--: | :--------------------------------: | :--------------------: |
|         6          |         4          |  >   | 02 llegal Data（非法数据地址错误） | 异常（01 83 02 C0 F1） |
|         6          |         5          |  >   | 02 llegal Data（非法数据地址错误） | 异常（01 83 02 C0 F1） |
|         6          |         6          |  =   |              正常读取              |          正常          |
|         4          |         6          |  <   |              读取正常              |          正常          |

#### 从站寄存器地址跳跃

**寄存器跳号**（好像那个模拟器搞不了跳号，只能看看有没有其他软件）





## 真实测试设备

### 串口

#### 主要信息

* `设备id：03，寄存器开始地址：0000，长度：2，波特率：2400，无校验位`

* 测试报文发送报文:

  > 03 03 00 00 00 02 C5 E9

* 解析响应报文

  `03 03 04 01 6B 01 03 E8 42`

  >03 设备id 
  >
  >03 操作码
  >
  >04 数据长度
  >
  >016B 0103 数据 --> 363 259
  >
  >E8 42 CRC

#### 手册解释

![image-20230427141150127](F:/blog/source/_posts/modbus.assets/image-20230427141150127.png)

#### 信息

**湿度**：363/10 = 36.3 RH

**温度**：259/10 = 25.9 摄氏度

#### 异常测试

* 这个设备只能读2个数据，但是现在要求测试读取 4个数据，5个数据，6个数据

| 读取数据个数 | 发送报文            | 响应报文                                   |
| ------------ | ------------------- | ------------------------------------------ |
| 5            | 0303 0000 0005 842B | 0303 0A 017B 00F7 0000 0000 0000 E20C      |
| 6            | 0303 0000 0006 C42A | 0303 0C 0182 00F7 0000 0000 0000 0000 6CFC |
| 1            | 0303 0000 0001 85E8 | 0303 02 018D 0071                          |
| 2            | 0303 0000 0002 C5E9 | 0303 04 018A 00F8 F867                     |

* 温湿度结论：读的寄存器大于设备本身寄存器，响应报文会填 0 补充。

## 通过网关

![image-20230427163655007](F:/blog/source/_posts/modbus.assets/image-20230427163655007.png)

## 编码

### 发送报文思路

* 设备地址
* 操作码
* 寄存器地址

* CRC (已完成)

### 分解响应思路：

* 先把响应报文接收到
* 分解（拆四部分）
  * 机器地址和操作码
  * 数据长度
  * 数据
  * CRC